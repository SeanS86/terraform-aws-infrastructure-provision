ubuntu@ip-172-18-4-39:~/wn_scripts$ sudo ./prepare-node.sh
+ echo 'Starting Node Preparation for Kubernetes...'
Starting Node Preparation for Kubernetes...
+ echo 'Updating package list and installing prerequisite packages...'
Updating package list and installing prerequisite packages...
+ sudo apt-get update
Hit:1 http://eu-west-1.ec2.archive.ubuntu.com/ubuntu xenial InRelease
Get:2 http://eu-west-1.ec2.archive.ubuntu.com/ubuntu xenial-updates InRelease [106 kB]
Get:3 http://eu-west-1.ec2.archive.ubuntu.com/ubuntu xenial-backports InRelease [106 kB]
Get:4 http://security.ubuntu.com/ubuntu xenial-security InRelease [106 kB]
Get:5 http://eu-west-1.ec2.archive.ubuntu.com/ubuntu xenial/universe amd64 Packages [7,532 kB]
Get:6 https://esm.ubuntu.com/apps/ubuntu xenial-apps-security InRelease [7,654 B]
Get:7 https://esm.ubuntu.com/apps/ubuntu xenial-apps-updates InRelease [7,545 B]
Get:8 https://esm.ubuntu.com/infra/ubuntu xenial-infra-security InRelease [7,554 B]
Get:9 https://esm.ubuntu.com/infra/ubuntu xenial-infra-updates InRelease [7,490 B]
Get:10 http://eu-west-1.ec2.archive.ubuntu.com/ubuntu xenial/universe Translation-en [4,354 kB]
Get:11 http://eu-west-1.ec2.archive.ubuntu.com/ubuntu xenial/multiverse amd64 Packages [144 kB]
Get:12 http://eu-west-1.ec2.archive.ubuntu.com/ubuntu xenial/multiverse Translation-en [106 kB]
Get:13 http://eu-west-1.ec2.archive.ubuntu.com/ubuntu xenial-updates/main amd64 Packages [1,269 kB]
Get:14 http://eu-west-1.ec2.archive.ubuntu.com/ubuntu xenial-updates/universe amd64 Packages [1,171 kB]
Get:15 http://eu-west-1.ec2.archive.ubuntu.com/ubuntu xenial-updates/universe Translation-en [334 kB]
Get:16 http://eu-west-1.ec2.archive.ubuntu.com/ubuntu xenial-updates/multiverse amd64 Packages [21.6 kB]
Get:17 http://eu-west-1.ec2.archive.ubuntu.com/ubuntu xenial-updates/multiverse Translation-en [8,440 B]
Get:18 http://eu-west-1.ec2.archive.ubuntu.com/ubuntu xenial-backports/main amd64 Packages [10.2 kB]
Get:19 http://eu-west-1.ec2.archive.ubuntu.com/ubuntu xenial-backports/main Translation-en [4,456 B]
Get:20 http://eu-west-1.ec2.archive.ubuntu.com/ubuntu xenial-backports/universe amd64 Packages [11.5 kB]
Get:21 http://eu-west-1.ec2.archive.ubuntu.com/ubuntu xenial-backports/universe Translation-en [4,476 B]
Get:22 http://security.ubuntu.com/ubuntu xenial-security/main amd64 Packages [913 kB]
Get:23 http://security.ubuntu.com/ubuntu xenial-security/universe amd64 Packages [741 kB]
Get:24 http://security.ubuntu.com/ubuntu xenial-security/universe Translation-en [203 kB]
Get:25 http://security.ubuntu.com/ubuntu xenial-security/multiverse amd64 Packages [7,864 B]
Get:26 http://security.ubuntu.com/ubuntu xenial-security/multiverse Translation-en [2,672 B]
Fetched 17.2 MB in 3s (5,703 kB/s)
Reading package lists... Done
+ sudo apt-get install -y apt-transport-https ca-certificates curl software-properties-common gnupg conntrack
Reading package lists... Done
Building dependency tree
Reading state information... Done
apt-transport-https is already the newest version (1.2.35).
software-properties-common is already the newest version (0.96.20.13).
ca-certificates is already the newest version (202402031~16.04.1~esm1).
curl is already the newest version (7.47.0-1ubuntu2.19+esm13).
gnupg is already the newest version (1.4.20-1ubuntu3.3+esm2).
The following NEW packages will be installed:
  conntrack
0 upgraded, 1 newly installed, 0 to remove and 16 not upgraded.
Need to get 27.3 kB of archives.
After this operation, 91.1 kB of additional disk space will be used.
Get:1 http://eu-west-1.ec2.archive.ubuntu.com/ubuntu xenial/main amd64 conntrack amd64 1:1.4.3-3 [27.3 kB]
Fetched 27.3 kB in 0s (0 B/s)
Selecting previously unselected package conntrack.
(Reading database ... 51961 files and directories currently installed.)
Preparing to unpack .../conntrack_1%3a1.4.3-3_amd64.deb ...
Unpacking conntrack (1:1.4.3-3) ...
Processing triggers for man-db (2.7.5-1ubuntu0.1~esm1) ...
Setting up conntrack (1:1.4.3-3) ...
+ echo 'Disabling swap...'
Disabling swap...
+ sudo swapoff -a
++ grep -c swap /etc/fstab
+ '[' 0 -gt 0 ']'
+ echo 'No swap entry found in /etc/fstab or already commented.'
No swap entry found in /etc/fstab or already commented.
+ echo 'Configuring kernel modules (overlay, br_netfilter)...'
Configuring kernel modules (overlay, br_netfilter)...
+ cat
+ sudo tee /etc/modules-load.d/k8s.conf
overlay
br_netfilter
+ sudo modprobe overlay
+ sudo modprobe br_netfilter
+ echo 'Configuring sysctl parameters for Kubernetes networking...'
Configuring sysctl parameters for Kubernetes networking...
+ sudo tee /etc/sysctl.d/k8s.conf
+ cat
net.bridge.bridge-nf-call-iptables  = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.ipv4.ip_forward                 = 1
+ sudo sysctl --system
* Applying /etc/sysctl.d/10-console-messages.conf ...
kernel.printk = 4 4 1 7
* Applying /etc/sysctl.d/10-ipv6-privacy.conf ...
net.ipv6.conf.all.use_tempaddr = 2
net.ipv6.conf.default.use_tempaddr = 2
* Applying /etc/sysctl.d/10-kernel-hardening.conf ...
kernel.kptr_restrict = 1
* Applying /etc/sysctl.d/10-link-restrictions.conf ...
fs.protected_hardlinks = 1
fs.protected_symlinks = 1
* Applying /etc/sysctl.d/10-lxd-inotify.conf ...
fs.inotify.max_user_instances = 1024
* Applying /etc/sysctl.d/10-magic-sysrq.conf ...
kernel.sysrq = 176
* Applying /etc/sysctl.d/10-network-security.conf ...
net.ipv4.conf.default.rp_filter = 1
net.ipv4.conf.all.rp_filter = 1
net.ipv4.tcp_syncookies = 1
* Applying /etc/sysctl.d/10-ptrace.conf ...
kernel.yama.ptrace_scope = 1
* Applying /etc/sysctl.d/10-zeropage.conf ...
vm.mmap_min_addr = 65536
* Applying /etc/sysctl.d/99-cloudimg-ipv6.conf ...
net.ipv6.conf.all.use_tempaddr = 0
net.ipv6.conf.default.use_tempaddr = 0
* Applying /etc/sysctl.d/99-sysctl.conf ...
* Applying /etc/sysctl.d/k8s.conf ...
net.bridge.bridge-nf-call-iptables = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.ipv4.ip_forward = 1
* Applying /etc/sysctl.conf ...
+ echo 'Kernel parameters applied.'
Kernel parameters applied.
+ echo 'Installing containerd...'
Installing containerd...
+ sudo install -m 0755 -d /etc/apt/keyrings
+ curl -fsSL https://download.docker.com/linux/ubuntu/gpg
+ sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
+ sudo chmod a+r /etc/apt/keyrings/docker.gpg
+ sudo tee /etc/apt/sources.list.d/docker.list
++ dpkg --print-architecture
++ . /etc/os-release
+++ NAME=Ubuntu
+++ VERSION='16.04.7 LTS (Xenial Xerus)'
+++ ID=ubuntu
+++ ID_LIKE=debian
+++ PRETTY_NAME='Ubuntu 16.04.7 LTS'
+++ VERSION_ID=16.04
+++ HOME_URL=http://www.ubuntu.com/
+++ SUPPORT_URL=http://help.ubuntu.com/
+++ BUG_REPORT_URL=http://bugs.launchpad.net/ubuntu/
+++ VERSION_CODENAME=xenial
+++ UBUNTU_CODENAME=xenial
++ echo xenial
+ echo 'deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu   xenial stable'
+ sudo apt-get update
Hit:1 http://eu-west-1.ec2.archive.ubuntu.com/ubuntu xenial InRelease
Hit:2 http://eu-west-1.ec2.archive.ubuntu.com/ubuntu xenial-updates InRelease
Hit:3 http://eu-west-1.ec2.archive.ubuntu.com/ubuntu xenial-backports InRelease
Get:4 https://download.docker.com/linux/ubuntu xenial InRelease [66.2 kB]
Hit:5 http://security.ubuntu.com/ubuntu xenial-security InRelease
Get:6 https://download.docker.com/linux/ubuntu xenial/stable amd64 Packages [21.0 kB]
Hit:7 https://esm.ubuntu.com/apps/ubuntu xenial-apps-security InRelease
Hit:8 https://esm.ubuntu.com/apps/ubuntu xenial-apps-updates InRelease
Hit:9 https://esm.ubuntu.com/infra/ubuntu xenial-infra-security InRelease
Hit:10 https://esm.ubuntu.com/infra/ubuntu xenial-infra-updates InRelease
Fetched 87.2 kB in 0s (94.7 kB/s)
Reading package lists... Done
+ sudo apt-get install -y containerd.io
Reading package lists... Done
Building dependency tree
Reading state information... Done
The following NEW packages will be installed:
  containerd.io
0 upgraded, 1 newly installed, 0 to remove and 16 not upgraded.
Need to get 28.0 MB of archives.
After this operation, 130 MB of additional disk space will be used.
Get:1 https://download.docker.com/linux/ubuntu xenial/stable amd64 containerd.io amd64 1.4.6-1 [28.0 MB]
Fetched 28.0 MB in 0s (54.3 MB/s)
Selecting previously unselected package containerd.io.
(Reading database ... 51969 files and directories currently installed.)
Preparing to unpack .../containerd.io_1.4.6-1_amd64.deb ...
Unpacking containerd.io (1.4.6-1) ...
Processing triggers for man-db (2.7.5-1ubuntu0.1~esm1) ...
Setting up containerd.io (1.4.6-1) ...
+ echo 'Configuring containerd to use systemd cgroup driver...'
Configuring containerd to use systemd cgroup driver...
+ sudo mkdir -p /etc/containerd
+ containerd config default
+ sudo tee /etc/containerd/config.toml
+ sudo sed -i 's/SystemdCgroup = false/SystemdCgroup = true/g' /etc/containerd/config.toml
+ sudo systemctl restart containerd
+ sudo systemctl enable containerd
+ echo 'Containerd installed and configured.'
Containerd installed and configured.
+ echo 'Installing Kubernetes components (kubeadm, kubelet, kubectl)...'
Installing Kubernetes components (kubeadm, kubelet, kubectl)...
+ K8S_MINOR_VERSION=v1.29
+ K8S_FULL_VERSION=1.29.1-1.1
+ sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
+ curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.29/deb/Release.key
+ sudo tee /etc/apt/sources.list.d/kubernetes.list
+ echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.29/deb/ /'
deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.29/deb/ /
+ sudo apt-get update
Hit:1 http://eu-west-1.ec2.archive.ubuntu.com/ubuntu xenial InRelease
Hit:2 http://eu-west-1.ec2.archive.ubuntu.com/ubuntu xenial-updates InRelease
Hit:3 http://eu-west-1.ec2.archive.ubuntu.com/ubuntu xenial-backports InRelease
Hit:4 http://security.ubuntu.com/ubuntu xenial-security InRelease
Hit:5 https://download.docker.com/linux/ubuntu xenial InRelease
Hit:6 https://esm.ubuntu.com/apps/ubuntu xenial-apps-security InRelease
Hit:7 https://esm.ubuntu.com/apps/ubuntu xenial-apps-updates InRelease
Hit:8 https://esm.ubuntu.com/infra/ubuntu xenial-infra-security InRelease
Hit:9 https://esm.ubuntu.com/infra/ubuntu xenial-infra-updates InRelease
Get:10 https://pkgs.k8s.io/core:/stable:/v1.29/deb  InRelease [138 B]
Get:11 https://pkgs.k8s.io/core:/stable:/v1.29/deb  Packages [21.3 kB]
Fetched 22.5 kB in 1s (21.8 kB/s)
Reading package lists... Done
+ sudo apt-get install -y kubelet=1.29.1-1.1 kubeadm=1.29.1-1.1 kubectl=1.29.1-1.1
Reading package lists... Done
Building dependency tree
Reading state information... Done
The following additional packages will be installed:
  cri-tools ebtables kubernetes-cni socat
The following NEW packages will be installed:
  cri-tools ebtables kubeadm kubectl kubelet kubernetes-cni socat
0 upgraded, 7 newly installed, 0 to remove and 16 not upgraded.
Need to get 92.3 MB of archives.
After this operation, 345 MB of additional disk space will be used.
Get:1 http://eu-west-1.ec2.archive.ubuntu.com/ubuntu xenial-updates/main amd64 ebtables amd64 2.0.10.4-3.4ubuntu2.16.04.2 [79.9 kB]
Get:2 http://eu-west-1.ec2.archive.ubuntu.com/ubuntu xenial/universe amd64 socat amd64 1.7.3.1-1 [321 kB]
Get:3 https://pkgs.k8s.io/core:/stable:/v1.29/deb  cri-tools 1.29.0-1.1 [20.1 MB]
Get:4 https://pkgs.k8s.io/core:/stable:/v1.29/deb  kubernetes-cni 1.3.0-1.1 [31.4 MB]
Get:5 https://pkgs.k8s.io/core:/stable:/v1.29/deb  kubelet 1.29.1-1.1 [19.8 MB]
Get:6 https://pkgs.k8s.io/core:/stable:/v1.29/deb  kubectl 1.29.1-1.1 [10.5 MB]
Get:7 https://pkgs.k8s.io/core:/stable:/v1.29/deb  kubeadm 1.29.1-1.1 [10.1 MB]
Fetched 92.3 MB in 1s (47.9 MB/s)
Selecting previously unselected package cri-tools.
(Reading database ... 51985 files and directories currently installed.)
Preparing to unpack .../cri-tools_1.29.0-1.1_amd64.deb ...
Unpacking cri-tools (1.29.0-1.1) ...
Selecting previously unselected package ebtables.
Preparing to unpack .../ebtables_2.0.10.4-3.4ubuntu2.16.04.2_amd64.deb ...
Unpacking ebtables (2.0.10.4-3.4ubuntu2.16.04.2) ...
Selecting previously unselected package kubernetes-cni.
Preparing to unpack .../kubernetes-cni_1.3.0-1.1_amd64.deb ...
Unpacking kubernetes-cni (1.3.0-1.1) ...
Selecting previously unselected package socat.
Preparing to unpack .../socat_1.7.3.1-1_amd64.deb ...
Unpacking socat (1.7.3.1-1) ...
Selecting previously unselected package kubelet.
Preparing to unpack .../kubelet_1.29.1-1.1_amd64.deb ...
Unpacking kubelet (1.29.1-1.1) ...
Selecting previously unselected package kubectl.
Preparing to unpack .../kubectl_1.29.1-1.1_amd64.deb ...
Unpacking kubectl (1.29.1-1.1) ...
Selecting previously unselected package kubeadm.
Preparing to unpack .../kubeadm_1.29.1-1.1_amd64.deb ...
Unpacking kubeadm (1.29.1-1.1) ...
Processing triggers for man-db (2.7.5-1ubuntu0.1~esm1) ...
Processing triggers for systemd (229-4ubuntu21.31+esm3) ...
Processing triggers for ureadahead (0.100.0-19.1) ...
Setting up cri-tools (1.29.0-1.1) ...
Setting up ebtables (2.0.10.4-3.4ubuntu2.16.04.2) ...
update-rc.d: warning: start and stop actions are no longer supported; falling back to defaults
Setting up kubernetes-cni (1.3.0-1.1) ...
Setting up socat (1.7.3.1-1) ...
Setting up kubelet (1.29.1-1.1) ...
Setting up kubectl (1.29.1-1.1) ...
Setting up kubeadm (1.29.1-1.1) ...
Processing triggers for systemd (229-4ubuntu21.31+esm3) ...
Processing triggers for ureadahead (0.100.0-19.1) ...
+ sudo apt-mark hold kubelet kubeadm kubectl
kubelet set on hold.
kubeadm set on hold.
kubectl set on hold.
+ echo 'Kubernetes components (kubelet, kubeadm, kubectl) version 1.29.1-1.1 installed and held.'
Kubernetes components (kubelet, kubeadm, kubectl) version 1.29.1-1.1 installed and held.
+ sudo systemctl enable --now kubelet
+ echo 'kubelet service enabled and started.'
kubelet service enabled and started.
+ echo 'Node Preparation Complete.'
Node Preparation Complete.
+ echo 'Consider rebooting the node if you encounter issues, though often not strictly necessary.'
Consider rebooting the node if you encounter issues, though often not strictly necessary.
